"use strict";(self.webpackChunkchartfactor_jlab_ext=self.webpackChunkchartfactor_jlab_ext||[]).push([[568],{774:(e,t,s)=>{s.d(t,{Z:()=>d});var o=s(138),a=s(439);const n={remove:function(e){localStorage.removeItem(e)},has:function(e){return localStorage.hasOwnProperty(e)},save:function(e,t){"string"!=typeof e&&(e=e.toString()),"string"!=typeof t&&(t=JSON.stringify(t)),localStorage.setItem(e,t)},get:function(e,t){let s=localStorage.getItem(e);if(null!==s)try{s=JSON.parse(s)}catch(e){}return null===s&&void 0!==t?t:s},getApps:function(){return(0,a.keys)(localStorage).filter((e=>e.includes("cfs.app-"))).map((e=>this.get(e)))},getHomeApps:function(){return(0,a.keys)(localStorage).filter((e=>e.includes("cfs.app-"))).map((e=>this.get(e))).filter((e=>"home"===e.state))},getAppsByPath:function(e){return(0,a.keys)(localStorage).filter((e=>e.includes("cfs.app-"))).map((e=>this.get(e))).filter((t=>t.folderPath===e))},getAppsByName:function(e,t=!1){return(0,a.keys)(localStorage).filter((e=>e.includes("cfs.app-"))).map((e=>this.get(e))).filter((s=>["home","favorite"].includes(s.state)&&(t&&s.name.toLowerCase()===e.toLowerCase()||!t&&s.name.toLowerCase().includes(e.toLowerCase()))))},getAll:function(){const e={};return(0,a.each)((0,a.keys)(localStorage),(t=>{t.includes("cfs.")&&(e[t]=this.get(t))})),e}};var i=s(797);const r=(e=null,t,s)=>{const o=s.currentWidget;return!!e&&!1!==e.activate&&o&&t.shell.activateById(o.id),o};var c=s(897);class d{constructor(e,t){this.app=e,this.notebooks=t,this.createIframe()}createIframe(){let e=document.getElementById("cfsIframe");if(!e){e=document.createElement("iframe");try{e.id="cfsIframe",e.name="cfsIframe",e.src="https://chartfactor.com/studio/",e.style.display="none",e.addEventListener("load",(()=>{this.resolve&&this.resolve(!0)})),document.body.appendChild(e)}catch(e){console.error("Oops, unable to create the Iframe element.",e)}}this.iframe=e}async onSave(e,t){const s=r(null,this.app,this.notebooks);if(s)switch(this.toJSON||(this.toJSON=s.model.toJSON),t){case"started":const e=this.toJSON.call(s.model);s.model.toJSON=(e=>()=>{let t=!1;return e.cells.forEach((e=>{"code"===e.cell_type&&e.source&&e.source.split("\n").forEach((s=>{if(s.match("studio\\((\\s?)+(app=)?[\\'\\\"](.*?)[\\'\\\"]")){const o=s.match("studio\\((\\s?)+(app=)?[\\'\\\"](.*?)[\\'\\\"]")[3];let i=n.getAppsByName(o,!0);i.sort(((e,t)=>e.creationDate-t.creationDate));const r=i.length;if(r>0){const s=i[r-1],o=(e=>{const t=n.get("cfs.dataProviders"),s=(0,a.uniqBy)(e.widgetList.map((e=>(0,a.get)(e,"source.provider.name",null))).filter((e=>e)));return t.filter((e=>!!s.includes(e.name)&&(e.customCode&&delete e.customCode,e.metadata&&delete e.metadata,!0)))})(s),c=s.id;e.metadata.cf_studio_app={},e.metadata.cf_studio_providers=[],e.metadata.cf_studio_app[`cfs.app-${c}`]=s,e.metadata.cf_studio_providers=(0,a.uniqBy)([...o],"name"),t=!0}}}))})),t&&i.INotification.success("The cf.studio apps changes were saved into this notebook"),e})(e);break;case"completed":s.model.toJSON=this.toJSON,delete this.toJSON}}cfsSynchronizeMessageEventListener(e){"synchronizeCfs"===e.data.action&&(e.data.storageItem?n.save(e.data.storageKey,e.data.storageItem):n.remove(e.data.storageKey))}async sendCfsInfoToStudio(e){if(delete this.iframeLoadedPromise,delete this.resolve,e.source.split("\n").forEach((e=>{if(e.includes("cf.studio")){const t=e.match("studio\\((\\s?)+(app=)?[\\'\\\"](.*)[\\'\\\"]\\,(\\s?)+(url=)?[\\'\\\"](.*?)[\\'\\\"]\\)");let s;t?(s=t[6],s&&s.startsWith("http")&&(s=s.trim(),s=s.replace(/\/?$/,"/"),this.iframeLoaded=$.Deferred())):s="https://chartfactor.com/studio/",this.iframe.src!==s&&(this.iframe.src=s,this.iframeLoadedPromise=new Promise(((e,t)=>{this.resolve=e})))}})),this.iframeLoadedPromise&&await this.iframeLoadedPromise,this.iframe){if(e.metadata.cf_studio_app){const t=_.keys(e.metadata.cf_studio_app);t&&t.length>0&&(e.metadata.cf_studio_app[t[0]].creationDate=Date.now(),console.log("Sending the cfs info stored in the notebook to ChartFactor Studio..."),this.iframe.contentWindow.postMessage({action:"synchronizeCfs",storageKey:t[0],storageItem:e.metadata.cf_studio_app[t[0]]},"*"))}e.metadata.cf_studio_providers&&this.iframe.contentWindow.postMessage({action:"synchronizeCfs",storageKey:"cfs.dataProviders",storageItem:e.metadata.cf_studio_providers},"*")}}createNew(e,t){return t.ready.then((async e=>{try{window.removeEventListener("message",window.cfsSynchronizeMessageEventListener,!1)}catch(e){}window.addEventListener("message",window.cfsSynchronizeMessageEventListener=this.cfsSynchronizeMessageEventListener,!1);const t=r(null,this.app,this.notebooks),s=t.model.toJSON(t.model);for(const e of s.cells)"code"===e.cell_type&&e.metadata&&await this.sendCfsInfoToStudio(e)})).catch((e=>console.error(e))),c.NotebookActions.executed.connect((async(e,t)=>{const{cell:s}=t;if("code"===s.model.type){const e=r(null,this.app,this.notebooks),t=e.model.toJSON(e.model),o=s.model.id,a=t.cells.find((e=>e.id===o));a&&a.metadata&&await this.sendCfsInfoToStudio(a)}})),t.saveState.connect(this.onSave,this),new o.DisposableDelegate((()=>{}))}}},568:(e,t,s)=>{s.r(t),s.d(t,{default:()=>c});var o=s(897),a=s(118),n=s(827);const i=s(788).Z,r=s(774).Z,c=[{id:"chartfactor_jlab_ext",autoStart:!0,requires:[o.INotebookTracker,a.ICommandPalette,n.IRenderMimeRegistry],activate:function(e,t,s,o){console.log("JupyterLab extension chartfactor_jlab_ext is activated!");const a=new i,n=new r(e,t);e.docRegistry.addWidgetExtension("Notebook",a),e.docRegistry.addWidgetExtension("Notebook",n)}}]},788:(e,t,s)=>{s.d(t,{Z:()=>n});var o=s(138);class a{constructor(e){this._sessionContext=e,this._future=null,this._kernel_id=void 0}future(e,t=null){this._future=e,e&&(e.onIOPub=e=>{switch(e.header.msg_type){case"execute_result":if(t){const s=e.content.data["text/plain"]||"";t(s)}else t("");break;case"display_data":case"update_display_data":t&&t("");break;case"stream":t(t?e.content.text.trim():"");break;case"error":t&&e.content.ename&&e.content.evalue?("name 'cf' is not defined"===e.content.evalue&&(e.content.evalue="Name 'cf' is not defined. Please execute 'from chartfactor import *' in any cell above."),t(`{"ename": "${e.content.ename}", "evalue": "${e.content.evalue}"}`)):t("")}})}execute(e,t=null){this._sessionContext&&this._sessionContext.session?.kernel&&this.future(this._sessionContext.session?.kernel?.requestExecute({code:e}),t)}}class n{createNew(e,t){const s=new a(t.sessionContext);return t.sessionContext.ready.then((e=>{s._kernel_id=t.sessionContext.session?.kernel?.id,window.JupyterLab||(window.JupyterLab={}),window.JupyterLab[s._kernel_id]={notebook:{kernel:s}}})).catch((e=>console.error(e))),new o.DisposableDelegate((()=>{}))}}}}]);