"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,n)=>{n.r(t),n.d(t,{default:()=>z});var l=n(337),o=n(503);const d="ipyflow",s={id:"jupyterlab-ipyflow",requires:[o.INotebookTracker],autoStart:!0,activate:(e,t)=>{t.widgetAdded.connect(((e,t)=>{const n=t.sessionContext;n.ready.then((()=>{M(t.content),p=t.content.activeCell,C=t.content.activeCell.model.id;let e=()=>{};n.session.kernel.name===d&&(e=T(n,t.content)),n.kernelChanged.connect(((l,o)=>{M(t.content),e(),e=()=>{},null!==o.newValue&&o.newValue.name===d&&(e=T(n,t.content))}));let l=!1;n.statusChanged.connect(((n,o)=>{"restarting"!==o&&"autorestarting"!==o||(l=!0),"idle"!==o&&"busy"!==o||!l||(l=!1,n.ready.then((()=>{M(t.content),e(),e=()=>{},n.session.kernel.name===d&&(e=T(n,t.content))})))}))}))}))}},a="waiting-cell",i="ready-cell",c="ready-making-cell",r="ready-making-input-cell",u="linked-waiting",m="linked-ready-maker";let h=new Set,f=new Set,v=new Set,_={},w={},p=null,C=null,y={},g={},L=null,E=null,k=null,x=new Set,S=new Set,b=new Set;const j=new Event("cleanup"),D=()=>{S=new Set,b=new Set,x=new Set},O=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},V=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},P=(e,t,n)=>{const l=()=>{e.removeEventListener(t,n),e.removeEventListener("cleanup",l)};e.addEventListener(t,n),e.addEventListener("cleanup",l)},q=(e,t,n,l,o)=>{null!==e&&null!==t&&P(e,n,(()=>{t.firstElementChild.classList[l](o)}))},A=(e,t)=>{q(O(e),V(e),"mouseover","add",u),q(O(e),V(e),"mouseout","remove",u),q(V(e),O(e),"mouseover","add",t),q(V(e),O(e),"mouseout","remove",t)},I=e=>{y={},g={},e.widgets.forEach(((e,t)=>{y[e.model.id]=e.node,g[e.model.id]=t}))},M=e=>{e.widgets.forEach(((e,t)=>{e.node.classList.remove(a),e.node.classList.remove(c),e.node.classList.remove(i),e.node.classList.remove(r);const n=O(e.node);null!==n&&(n.firstElementChild.classList.remove(u),n.firstElementChild.classList.remove(m),n.dispatchEvent(j));const l=V(e.node);null!==l&&(l.firstElementChild.classList.remove(u),l.firstElementChild.classList.remove(m),l.dispatchEvent(j))}))},N=(e,t,n,l,o,d,s)=>{if(null===e)return;const a=()=>{for(const e of t){let t=m;s.has(e)&&(t=u);const o=l(n[e]);if(null===o||null===o.firstElementChild)return;o.firstElementChild.classList[d](t)}};e.addEventListener(o,a),P(e,o,a)},T=(e,t)=>{const n=e.session.kernel.createComm("ipyflow");let o=!1;const d=(s,a)=>{if(o)return void s.stateChanged.disconnect(d);if("executionCount"!==a.name||null===a.newValue)return;const c={},u={};t.widgets.forEach(((e,t)=>{c[e.model.id]=t,u[e.model.id]=e.model.value.text,e.model.id===s.id&&(e.node.classList.remove(i),e.node.classList.remove(r))}));const m={type:"compute_exec_schedule",executed_cell_id:s.id,order_index_by_cell_id:c,content_by_cell_id:u};n.send(m).done.then((()=>{null!==L?l.CodeCell.execute(L,e):("reactive"===E&&(v=x,q(t)),D(),n.send({type:"reactivity_cleanup"}))}))},s=e=>{let l=-1;t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(l=n)}));const o={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:l};n.send(o)},g=(e,n)=>{if(t===e)if(o)t.activeCellChanged.disconnect(g);else if(s(n.model),null!==p&&null!==p.model&&(p.model.isDirty?h.add(C):h.delete(C),p.model.stateChanged.disconnect(d,p.model.stateChanged)),p=n,C=n.model.id,null!==p&&null!==p.model&&"code"===p.model.type){if(p.model.stateChanged.connect(d),s(p.model),h.has(C)){const e=p.model;void 0!==e._setDirty&&e._setDirty(!0)}I(t),P(C)}};t.activeCellChanged.connect(g);const j=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],P=e=>{const t=y[e];f.has(e)?(t.classList.add(a),t.classList.add(i),t.classList.remove(r),A(t,u)):v.has(e)&&(t.classList.add(r),"normal"===E&&(t.classList.add(i),A(t,m))),"reactive"!==E&&(_.hasOwnProperty(e)&&j.forEach((({action:n,update:l})=>{N(O(t),_[e],y,O,n,l,f),N(V(t),_[e],y,O,n,l,f)})),w.hasOwnProperty(e)&&(f.has(e)||(t.classList.add(c),t.classList.add(i)),j.forEach((({action:n,update:l})=>{N(O(t),w[e],y,O,n,l,f),N(O(t),w[e],y,V,n,l,f)}))))},q=e=>{if(M(e),k){I(e);for(const[e]of Object.entries(y))P(e)}};return n.onMsg=e=>{if(!o)if("establish"===e.content.data.type)t.activeCell.model.stateChanged.connect(d),s(t.activeCell.model);else if("compute_exec_schedule"===e.content.data.type){f=new Set(e.content.data.waiting_cells),v=new Set(e.content.data.ready_cells),S=new Set([...S,...e.content.data.new_ready_cells]),b=new Set([...b,...e.content.data.forced_reactive_cells]),_=e.content.data.waiter_links,w=e.content.data.ready_maker_links,L=null;const n=e.content.data.exec_mode,l=e.content.data.flow_order,o=e.content.data.exec_schedule;E=n,k=e.content.data.highlights_enabled,x.add(e.content.data.last_executed_cell_id);for(const e of t.widgets){if("code"!==e.model.type||x.has(e.model.id))continue;if(!(b.has(e.model.id)||"reactive"===n&&S.has(e.model.id)))continue;const t=e;if(null===L){if(L=t,"in_order"===l||"strict"===o)break}else null==t.model.executionCount||t.model.executionCount<L.model.executionCount&&(L=t)}null===L?(D(),q(t)):(g(t,L),M(t))}},n.open({}),()=>{o=!0}},z=s}}]);